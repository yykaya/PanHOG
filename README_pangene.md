# Pangene usage with PanHOG

This module integrates the [pangene](https://github.com/lh3/pangene) tool with the PanHOG pipeline to analyze gene presence/absence across multiple genomes using protein-to-genome alignments.

## Table of Contents
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Quick Start](#quick-start)
- [Detailed Usage](#detailed-usage)
  - [Required Arguments](#required-arguments)
  - [Clustering Options](#clustering-options)
  - [Advanced Options](#advanced-options)
  - [Configuration File](#configuration-file)
- [Workflow](#workflow)
- [Output Files](#output-files)
- [Troubleshooting](#troubleshooting)
- [Example Workflow](#example-workflow)

## Prerequisites

1. Python 3.9 or higher
2. Required tools:
   - miniprot (v0.10 or higher) https://github.com/lh3/miniprot
   - pangene (latest version recommended) 
   - DIAMOND (v2.0+ for clustering, optional) https://github.com/bbuchfink/diamond
   - seqtk (for sequence manipulation, optional) https://github.com/lh3/seqtk

## Installation

1. Clone the repository:
```bash
git clone https://github.com/yykaya/PanHOG.git
cd PanHOG
```

2. Install dependencies:
```bash
pip install biopython pyyaml pandas
```

3. Install required tools:
```bash
# Install miniprot
conda install -c bioconda miniprot

# Install pangene
conda install -c bioconda pangene

# Optional: Install DIAMOND for clustering
conda install -c bioconda diamond

# Optional: Install seqtk
conda install -c bioconda seqtk
```

## Quick Start

```bash
python pangene_panHOG.py \
    --pan-proteome pan_proteome.fa \
    --genomes genome1.fa genome2.fa genome3.fa
```

## Detailed Usage

### Required Arguments

| Argument | Description |
|----------|-------------|
| `--pan-proteome` | Path to pan_proteome.fa file generated by PanHOG |
| `--genomes` | One or more genome FASTA files (space-separated) |

### Clustering Options

| Option | Default | Description |
|--------|---------|-------------|
| `--skip-clustering` | False | Skip the protein clustering step |
| `--skip-filtering` | False | Skip amino acid filtering |
| `--identity` | 90.0 | Minimum percent identity for clustering (0-100) |
| `--coverage` | 80.0 | Minimum coverage for clustering (0-100) |
| `--threads` | 8 | Number of threads to use |
| `--memory` | 64G | Memory limit for DIAMOND

### Advanced Options

| Option | Description |
|--------|-------------|
| `--diamond-path` | Path to DIAMOND executable |
| `--seqtk-path` | Path to seqtk executable |
| `--miniprot-cmd` | Custom miniprot command (overrides defaults) |
| `--pangene-cmd` | Custom pangene command (overrides defaults) |

### Configuration File

You can also use a YAML configuration file to specify these options. Command-line arguments will override the config file.

Example `config.yaml`:
```yaml
working_dir: "./pangene_results"
clustering:
  identity: 90.0
  coverage: 80.0
  threads: 8
  memory: "64G"
diamond_path: "diamond"
seqtk_path: "seqtk"
miniprot_cmd: ["miniprot", "--outs=0.97", "--no-cs", "-Iut16"]
pangene_cmd: ["pangene"]
```

## Workflow

1. **Input Processing**
   - Validates input files and parameters
   - Creates output directory structure

2. **Protein Clustering (Optional)**
   - Clusters proteins using DIAMOND linclust (see: https://github.com/bbuchfink/diamond/wiki/Clustering)
   - Filters sequences based on identity and coverage thresholds
   - Output: `clustered_proteins.faa`

3. **Miniprot Alignment**
   - Aligns proteins to each genome using miniprot
   - Default parameters: `--outs=0.97 --no-cs -Iut16`
   - Generates one PAF file per genome

4. **Pangene Graph Construction**
   - Processes all PAF files directly
   - Builds pangene graph using the pangene tool
   - Output: `graph.gfa`

5. **Graph Analysis**
   - Analyzes the pangene graph
   - Generates gene presence/absence matrix
   - Output: `gene_presence_absence.Rtab`

## Output Files

All output files are saved in the working directory (default: `./pangene_results`):

- `proteins.faa`: Formatted protein sequences
- `*.paf`: Miniprot alignment files (one per genome)
- `graph.gfa`: Pangene graph file
- `bubble.txt`: Bubble information from pangene.js
- `gene_presence_absence.Rtab`: Final gene presence/absence matrix
- `clustering/`: Directory containing clustering results (if clustering performed)
  - `clustered_proteins.faa`
  - `clustered_proteins.tsv`
  - `diamond.log`

## Troubleshooting

### Common Issues

1. **Miniprot and DIAMOND not found**
   - Ensure miniprot and DIAMOND are installed and in your PATH

### Logging

Detailed logs are printed to stderr. For more verbose output, you can modify the logging level in the script.

## Example Workflow

```bash
# 1. Run the pipeline with clustering
python pangene_panHOG.py \
    --pan-proteome pan_proteome.fa \
    --genomes genome1.fa genome2.fa genome3.fa \
    --identity 95.0 \
    --coverage 85.0 \
    --threads 16 \
    --memory 128G

# 2. Run with custom miniprot parameters
python pangene_panHOG.py \
    --pan-proteome pan_proteome.fa \
    --genomes genome1.fa \
    --miniprot-cmd "miniprot --outs=0.95 --no-cs -Iut16 -t 8"

# 3. Run with configuration file
python pangene_panHOG.py \
    --config config.yaml \
    --pan-proteome pan_proteome.fa \
    --genomes genome1.fa genome2.fa

# 4. View results
head -n 10 pangene_results/gene_presence_absence.Rtab
```

For more information, please refer to the [pangene documentation](https://github.com/lh3/pangene).

Citation: ```Heng Li, Maximillian Marin, Maha R Farhat, Exploring gene content with pangene graphs, Bioinformatics, Volume 40, Issue 7, July 2024, btae456, https://doi.org/10.1093/bioinformatics/btae456```
